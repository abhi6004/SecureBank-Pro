@using Newtonsoft.Json
@model List<SecureBank_Pro.BankEntities.Users>

@{
    var newUser = JsonConvert.DeserializeObject<SecureBank_Pro.BankEntities.Users>(Context.Session.GetString("UserData"));
    string Current = ViewBag.Current;
    string username = newUser.full_name;
    string userRole = newUser.role; // lowercase
    int userId = newUser.id;
}

@functions {
    // Helper function for department
    public string GetDepartment(SecureBank_Pro.BankEntities.Users u)
    {
        if (u.role == "Manager" || u.role == "Employee") return u.branch_assigned ?? "";
        if (u.role == "Auditor") return u.assigned_region ?? "";
        return "";
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/Chat/chat.css" />
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="~/js/Chat/ChatRoom.js"></script>
    <script>
        var userRole = '@userRole'; // for JS room restriction
    </script>
}

<div class="chat-wrapper">

    <!-- LEFT SIDEBAR -->
    <div class="chat-list">

        <h2>General Chat</h2>
        <div onclick="OpenChat('','general', '', @userId)" class="chat-item">
            General Room
        </div>

        <h2>Room Chats</h2>
        @if (newUser.role == "Manager")
        {
            <div onclick="OpenChat('manager','room','Manager', @userId)" class="chat-item">Manager Room</div>
        }
        @if (newUser.role == "Employee")
        {
            <div onclick="OpenChat('employee','room','Employee',@userId)" class="chat-item">Employee Room</div>
        }
        @if (newUser.role == "Auditor")
        {
            <div onclick="OpenChat('auditor','room','Auditor',@userId)" class="chat-item">Auditor Room</div>
        }

        <h2>Private Chats</h2>
        @foreach (var user in Model)
        {
            if (user.id != newUser.id)
            {
                <div onclick="OpenChat('@user.full_name','private', '',@userId)" class="chat-item">
                    @user.full_name (@user.role)
                </div>
            }
        }
    </div>

    <!-- RIGHT CHAT PANEL -->
    <div class="chat-window">

        <div id="chat-title" class="chat-title">
            Select chat to start messaging
        </div>

        <div id="chat-content" class="chat-content">
            <!-- Chat messages will load here -->
        </div>

        <div class="chat-input-box">
            <input id="main-message-box" type="text" placeholder="Type message..." />
            <button onclick="SendActiveChat()">Send</button>
        </div>

    </div>

</div>
